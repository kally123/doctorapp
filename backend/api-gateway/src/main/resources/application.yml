spring:
  application:
    name: api-gateway

  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

  # Redis for rate limiting
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}

  cloud:
    gateway:
      # Global CORS configuration
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

      # Default filters applied to all routes
      default-filters:
        - name: RequestLogging
        - name: AddCorrelationId

      # Route definitions
      routes:
        # ==================== USER SERVICE ====================
        # Public endpoints (no authentication required)
        - id: user-public
          uri: ${USER_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/v1/users/register, /api/v1/users/login, /api/v1/users/verify-otp, /api/v1/users/forgot-password, /api/v1/users/reset-password, /api/v1/users/refresh-token
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                key-resolver: "#{@ipKeyResolver}"

        # Protected user endpoints
        - id: user-protected
          uri: ${USER_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/v1/users/**
          filters:
            - JwtAuthFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                key-resolver: "#{@userKeyResolver}"

        # ==================== DOCTOR SERVICE ====================
        # Public doctor endpoints (search, view profiles)
        - id: doctor-public
          uri: ${DOCTOR_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/v1/doctors/search, /api/v1/doctors/search/**, /api/v1/doctors/{id}, /api/v1/specializations, /api/v1/specializations/**
            - Method=GET
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                key-resolver: "#{@ipKeyResolver}"

        # Protected doctor endpoints
        - id: doctor-protected
          uri: ${DOCTOR_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/v1/doctors/**
          filters:
            - JwtAuthFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                key-resolver: "#{@userKeyResolver}"

        # ==================== SEARCH SERVICE ====================
        - id: search-service
          uri: ${SEARCH_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/v1/search/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                key-resolver: "#{@ipKeyResolver}"

        # ==================== APPOINTMENT SERVICE ====================
        # Public availability endpoints
        - id: appointment-public
          uri: ${APPOINTMENT_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/v1/availability/doctors/{doctorId}/slots
            - Method=GET
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                key-resolver: "#{@ipKeyResolver}"

        # Protected availability management (doctors)
        - id: availability-management
          uri: ${APPOINTMENT_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/v1/availability/**
          filters:
            - JwtAuthFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                key-resolver: "#{@userKeyResolver}"

        # Protected appointment endpoints
        - id: appointments-protected
          uri: ${APPOINTMENT_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/v1/appointments/**
          filters:
            - JwtAuthFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                key-resolver: "#{@userKeyResolver}"

        # ==================== PAYMENT SERVICE ====================
        # Webhook endpoint (no auth, Razorpay signature verification)
        - id: payment-webhook
          uri: ${PAYMENT_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/api/v1/payments/webhook
            - Method=POST
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                key-resolver: "#{@ipKeyResolver}"

        # Protected payment endpoints
        - id: payments-protected
          uri: ${PAYMENT_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/api/v1/payments/**
          filters:
            - JwtAuthFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                key-resolver: "#{@userKeyResolver}"

        # ==================== NOTIFICATION SERVICE ====================
        # Protected notification endpoints
        - id: notifications-protected
          uri: ${NOTIFICATION_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/api/v1/notifications/**
          filters:
            - JwtAuthFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                key-resolver: "#{@userKeyResolver}"

# JWT Configuration
jwt:
  secret: ${JWT_SECRET:your-256-bit-secret-key-for-jwt-signing-must-be-at-least-32-chars}

# Server Configuration
server:
  port: ${SERVER_PORT:8080}

# Actuator Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,gateway
  endpoint:
    health:
      show-details: when-authorized
    gateway:
      enabled: true

# Logging
logging:
  level:
    com.healthapp: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web.reactive: DEBUG
